/**
 * Created by Michael on 31/12/13.
 */
var MicrophoneAudioSource=function(){var g=this;this.volume=0;this.streamData=new Uint8Array(128);var h,f=function(){h.getByteFrequencyData(g.streamData);var b=0,f;for(f in g.streamData)b+=g.streamData[f];g.volume=b};navigator.getMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;navigator.getMedia({audio:!0},function(b){var g=new (window.AudioContext||window.webkitAudioContext);b=g.createMediaStreamSource(b);h=g.createAnalyser();h.fftSize=
256;b.connect(h);setInterval(f,20)},function(){alert("error getting microphone input.")})},SoundCloudAudioSource=function(g){var h=this,f,b=new (window.AudioContext||window.webkitAudioContext);f=b.createAnalyser();f.fftSize=256;g.crossOrigin="anonymous";b.createMediaElementSource(g).connect(f);f.connect(b.destination);setInterval(function(){f.getByteFrequencyData(h.streamData);for(var b=0,c=0;80>c;c++)b+=h.streamData[c];h.volume=b},20);this.volume=0;this.streamData=new Uint8Array(128);this.playStream=
function(b){g.addEventListener("ended",function(){b.directStream("coasting")});g.setAttribute("src",b.streamUrl());g.play()}},Visualizer=function(){function g(a,e,b,d,c,f){this.sides=a;this.tileSize=d;this.ctx=c;this.num=f;this.high=0;this.decay=42<this.num?1.5:2;this.highlight=0;a=Math.round(Math.cos(Math.PI/6)*d*2);this.y=Math.round(a*Math.sin(Math.PI/3)*-b);this.x=Math.round(e*a+b*a/2);this.vertices=[];for(a=1;a<=this.sides;a+=1)e=this.x+this.tileSize*Math.cos(2*a*Math.PI/this.sides+Math.PI/6),
b=this.y+this.tileSize*Math.sin(2*a*Math.PI/this.sides+Math.PI/6),this.vertices.push([e,b])}function h(a,e,b,d){this.x=a;this.y=e;this.angle=Math.atan(Math.abs(e)/Math.abs(a));this.starSize=b;this.ctx=d;this.high=0}var f,b=[],l=[],c,d,k,n,p,q,m;g.prototype.rotateVertices=function(){var a;a=.001-(1E4<m.volume?Math.sin(m.volume/8E5):0);for(var e=0;e<=this.sides-1;e+=1)this.vertices[e][0]-=this.vertices[e][1]*Math.sin(a),this.vertices[e][1]+=this.vertices[e][0]*Math.sin(a)};g.prototype.calculateOffset=
function(a){var e=Math.atan(a[1]/a[0]),b=m.volume/2E6*Math.pow(Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2))/3,2)*(Math.pow(this.high,1.3)/300)*Math.min(Math.max(.5*Math.tan(m.volume/6E3),-20),2),d=Math.cos(e)*b,e=Math.sin(e)*b,d=d*(0>a[0]?-1:1),e=e*(0>a[0]?-1:1);return[d,e]};g.prototype.drawPolygon=function(){var a=255*Math.pow(m.streamData[Math.ceil(m.streamData.length/b.length*this.num)]/255,2),a=a*(42<this.num?1.1:1);a>this.high?this.high=a:a=this.high-=this.decay;var e,d,c,f;if(0<a){this.ctx.beginPath();
e=this.calculateOffset(this.vertices[0]);this.ctx.moveTo(this.vertices[0][0]+e[0],this.vertices[0][1]+e[1]);for(d=1;d<=this.sides-1;d+=1)e=this.calculateOffset(this.vertices[d]),this.ctx.lineTo(this.vertices[d][0]+e[0],this.vertices[d][1]+e[1]);this.ctx.closePath();128<a?(e=2*(a-128),d=128*(Math.cos(2*a/128*Math.PI/2-4*Math.PI/3)+1),c=3*(a-105)):175<a?(e=2*(a-128),d=255,c=3*(a-105)):(e=128*(Math.cos(2*a/128*Math.PI/2)+1),d=128*(Math.cos(2*a/128*Math.PI/2-4*Math.PI/3)+1),c=128*(Math.cos(2.4*a/128*
Math.PI/2-2*Math.PI/3)+1));210<a&&(this.cubed=a);120<a&&(this.highlight=100);f=.5/(1+40*Math.pow(2.7182,-a/8))+.5/(1+40*Math.pow(2.7182,-a/20));this.ctx.fillStyle="rgba("+Math.round(e)+", "+Math.round(d)+", "+Math.round(c)+", "+f+")";this.ctx.fill();20<a&&(this.ctx.strokeStyle="rgba(20, 20, 20, 0.5)",this.ctx.lineWidth=1,this.ctx.stroke())}};g.prototype.drawHighlight=function(){this.ctx.beginPath();var a=this.calculateOffset(this.vertices[0]);this.ctx.moveTo(this.vertices[0][0]+a[0],this.vertices[0][1]+
a[1]);for(var e=0;e<=this.sides-1;e+=1)a=this.calculateOffset(this.vertices[e]),this.ctx.lineTo(this.vertices[e][0]+a[0],this.vertices[e][1]+a[1]);this.ctx.closePath();this.ctx.strokeStyle="rgba(255, 255, 255, "+this.highlight/100+")";this.ctx.lineWidth=1;this.ctx.stroke();this.highlight-=.5};var r=function(){b=[];var a=0;b.push(new g(6,0,0,f,d,a));a++;for(var e=1;7>e;e++){b.push(new g(6,0,e,f,d,a));a++;b.push(new g(6,0,-e,f,d,a));a++;for(var c=1;c<e;c++)b.push(new g(6,c,-e,f,d,a)),a++,b.push(new g(6,
-c,e,f,d,a)),a++,b.push(new g(6,c,e-c,f,d,a)),a++,b.push(new g(6,-c,-e+c,f,d,a)),a++;for(c=-e;0>=c;c++)b.push(new g(6,e,c,f,d,a)),a++,b.push(new g(6,-e,-c,f,d,a)),a++}};h.prototype.drawStar=function(){var a=Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2)),e=200+Math.min(Math.round(5*this.high),55);this.ctx.lineWidth=.5+a/2E3*Math.max(this.starSize/2,1);this.ctx.strokeStyle="rgba("+e+", "+e+", "+e+", 1)";this.ctx.beginPath();this.ctx.moveTo(this.x,this.y);var a=1+Math.min(Math.pow(a,2)/3E4*Math.pow(m.volume,
2)/6E6,a),e=Math.cos(this.angle)*-a,d=Math.sin(this.angle)*-a,e=e*(0<this.x?1:-1),d=d*(0<this.y?1:-1);this.ctx.lineTo(this.x+e,this.y+d);this.ctx.stroke();this.ctx.closePath();a=a/20*this.starSize;this.high-=Math.max(this.high-1E-4,0);a>this.high&&(this.high=a);a=Math.cos(this.angle)*this.high;e=Math.sin(this.angle)*this.high;this.x+=0<this.x?a:-a;this.y+=0<this.y?e:-e;a=c.height/2+500;e=c.width/2+500;if(this.y>a||this.y<-a||this.x>e||this.x<-e)this.x=(Math.random()-.5)*c.width/3,this.y=(Math.random()-
.5)*c.height/3,this.angle=Math.atan(Math.abs(this.y)/Math.abs(this.x))};var t=function(){var a,d,b;l=[];for(var f=c.width/15,g=0;g<f;g++)a=(Math.random()-.5)*c.width,d=(Math.random()-.5)*c.height,b=3*(Math.random()+.1),l.push(new h(a,d,b,q))},u=function(){n.clearRect(0,0,k.width,k.height);var a,d,c,b=m.volume/1E3;a=200+28*(Math.sin(b)+1);d=2*b;c=8*b;n.beginPath();n.rect(0,0,k.width,k.height);b=n.createRadialGradient(k.width/2,k.height/2,b,k.width/2,k.height/2,k.width-Math.min(Math.pow(b,2.7),k.width-
20));b.addColorStop(0,"rgba(0,0,0,0)");b.addColorStop(.8,"rgba("+Math.round(a)+", "+Math.round(d)+", "+Math.round(c)+", 0.4)");n.fillStyle=b;n.fill()};this.resizeCanvas=function(){c&&(c.width=window.innerWidth,c.height=window.innerHeight,d.translate(c.width/2,c.height/2),k.width=window.innerWidth,k.height=window.innerHeight,p.width=window.innerWidth,p.height=window.innerHeight,q.translate(c.width/2,c.height/2),f=c.width>c.height?c.width/25:c.height/25,u(),r(),t())};var w=function(){b.forEach(function(a){a.rotateVertices()})},
v=function(){d.clearRect(-c.width,-c.height,2*c.width,2*c.height);q.clearRect(-c.width/2,-c.height/2,c.width,c.height);l.forEach(function(a){a.drawStar()});b.forEach(function(a){a.drawPolygon()});b.forEach(function(a){0<a.highlight&&a.drawHighlight()});requestAnimationFrame(v)};this.init=function(a){m=a.audioSource;a=document.getElementById(a.containerId);c=document.createElement("canvas");c.setAttribute("style","position: absolute; z-index: 10");d=c.getContext("2d");a.appendChild(c);p=document.createElement("canvas");
q=p.getContext("2d");p.setAttribute("style","position: absolute; z-index: 5");a.appendChild(p);k=document.createElement("canvas");n=k.getContext("2d");a.appendChild(k);r();t();this.resizeCanvas();v();setInterval(u,100);setInterval(w,20);window.addEventListener("resize",this.resizeCanvas,!1)}},SoundcloudLoader=function(g,h){var f=this;this.sound={};this.errorMessage=this.streamUrl="";this.player=g;this.uiUpdater=h;this.loadStream=function(b,g,c){SC.initialize({client_id:"ec8f5272bde9a225c71692a876603706"});
SC.get("/resolve",{url:b},function(d){if(d.errors){f.errorMessage="";for(var b=0;b<d.errors.length;b++)f.errorMessage+=d.errors[b].error_message+"<br>";f.errorMessage+="Make sure the URL has the correct format: https://soundcloud.com/user/title-of-the-track";c()}else"playlist"==d.kind?(f.sound=d,f.streamPlaylistIndex=0,f.streamUrl=function(){return d.tracks[f.streamPlaylistIndex].stream_url+"?client_id=ec8f5272bde9a225c71692a876603706"}):(f.sound=d,f.streamUrl=function(){return d.stream_url+"?client_id=ec8f5272bde9a225c71692a876603706"}),
g()})};this.directStream=function(b){"toggle"==b?this.player.paused?this.player.play():this.player.pause():"playlist"==this.sound.kind&&("coasting"==b?this.streamPlaylistIndex++:"forward"==b?this.streamPlaylistIndex>=this.sound.track_count-1?this.streamPlaylistIndex=0:this.streamPlaylistIndex++:0>=this.streamPlaylistIndex?this.streamPlaylistIndex=this.sound.track_count-1:this.streamPlaylistIndex--,0<=this.streamPlaylistIndex&&this.streamPlaylistIndex<=this.sound.track_count-1&&(this.player.setAttribute("src",
this.streamUrl()),this.uiUpdater.update(this),this.player.play()))}},UiUpdater=function(){var g=document.getElementById("controlPanel"),h=document.getElementById("trackInfoPanel"),f=document.getElementById("infoImage"),b=document.getElementById("infoArtist"),l=document.getElementById("infoTrack"),c=document.getElementById("messageBox");this.clearInfoPanel=function(){b.innerHTML="";l.innerHTML="";h.className="hidden"};this.update=function(d){var c=document.createElement("a");c.setAttribute("href",
d.sound.user.permalink_url);c.setAttribute("target","_blank");c.innerHTML=d.sound.user.username;var g=document.createElement("a");g.setAttribute("href",d.sound.permalink_url);g.setAttribute("target","_blank");g.innerHTML="playlist"==d.sound.kind?"<p>"+d.sound.tracks[d.streamPlaylistIndex].title+"</p><p>"+d.sound.title+"</p>":d.sound.title;f.setAttribute("src",d.sound.artwork_url?d.sound.artwork_url:d.sound.user.avatar_url);b.innerHTML="";b.appendChild(c);l.innerHTML="";l.appendChild(g);h.className=
"";d=d.sound.permalink_url.substr(22);window.location="#"+d};this.toggleControlPanel=function(){0===g.className.indexOf("hidden")?g.className="":g.className="hidden"};this.displayMessage=function(d,b){c.innerHTML="";var f=document.createElement("h3");f.innerHTML=d;var g=document.createElement("p");g.innerHTML=b;var h=document.createElement("a");h.setAttribute("href","#");h.innerHTML="close";h.addEventListener("click",function(b){b.preventDefault();c.className="hidden"});c.className="";c.appendChild(f);
c.appendChild(g);c.appendChild(h)}};
window.onload=function(){var g=new Visualizer,h=document.getElementById("player"),f=new UiUpdater,b=new SoundcloudLoader(h,f),l=new SoundCloudAudioSource(h),h=document.getElementById("form"),c=function(d){b.loadStream(d,function(){f.clearInfoPanel();l.playStream(b);f.update(b);setTimeout(f.toggleControlPanel,3E3)},function(){f.displayMessage("Error",b.errorMessage)})};g.init({containerId:"visualizer",audioSource:l});f.toggleControlPanel();window.location.hash&&(g="https://soundcloud.com/"+window.location.hash.substr(1),
c(g));h.addEventListener("submit",function(b){b.preventDefault();b=document.getElementById("input").value;c(b)});document.getElementById("toggleButton").addEventListener("click",function(b){b.preventDefault();f.toggleControlPanel()});window.addEventListener("keydown",function(c){switch(c.keyCode){case 32:b.directStream("toggle");break;case 37:b.directStream("backward");break;case 39:b.directStream("forward")}},!1)};